{% extends "base.html" %}
{% block content %}
{% include 'nav.html' %}

<div class="container-fluid mt-3">
    <div class="row g-3">
        <div class="col-xl-8 col-lg-12">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h2 class="mb-0">Manage</h2>
                <span class="text-muted small">Library maintenance actions</span>
            </div>

            <div id="manageAlert" class="alert alert-info d-none mb-3" role="alert"></div>

            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Library organization</h5>
                    <p class="card-text mb-3">Rename and organize identified content into structured folders.</p>
                    <div class="d-flex flex-wrap gap-3 align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="organizeDryRun" checked>
                            <label class="form-check-label" for="organizeDryRun">Dry run</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="organizeVerbose">
                            <label class="form-check-label" for="organizeVerbose">Verbose</label>
                        </div>
                        <button type="button" id="organizeLibraryBtn" class="btn btn-primary ms-auto"
                            onClick='organizeLibrary()'>Organize library</button>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Delete older updates</h5>
                    <p class="card-text mb-3">Keep the latest owned update per title and remove older update files.</p>
                    <div class="d-flex flex-wrap gap-3 align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="deleteUpdatesDryRun" checked>
                            <label class="form-check-label" for="deleteUpdatesDryRun">Dry run</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="deleteUpdatesVerbose">
                            <label class="form-check-label" for="deleteUpdatesVerbose">Verbose</label>
                        </div>
                        <button type="button" id="deleteUpdatesBtn" class="btn btn-danger ms-auto"
                            onClick='deleteOlderUpdates()'>Delete older updates</button>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Convert NSP/XCI to NSZ</h5>
                    <p class="card-text mb-3">Automatically convert NSP/XCI files to NSZ using a configured tool.</p>
                    <div class="mb-2">
                        <label for="converterCommandInput" class="form-label">Converter command</label>
                        <input type="text" class="form-control" id="converterCommandInput"
                            value='{nsz_exe} -C -o "{output_dir}" "{input_file}"'>
                        <div class="form-text">
                            Supports placeholders: <code>{input_file}</code>, <code>{output_file}</code>, <code>{output_dir}</code>.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="convertSingleSelect" class="form-label">Manual single-file conversion</label>
                        <div class="input-group">
                            <select class="form-select" id="convertSingleSelect">
                                <option value="">Loading files...</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" id="refreshConvertiblesBtn"
                                onClick="loadConvertibleFiles()">Refresh</button>
                            <button class="btn btn-outline-warning" type="button" id="convertSingleBtn"
                                onClick="convertSingleFile()">Convert selected</button>
                        </div>
                        <div class="form-text">Only NSP/XCI files are listed.</div>
                    </div>
                    <div class="d-flex flex-wrap gap-3 align-items-center">
                        <div class="input-group" style="max-width: 180px;">
                            <span class="input-group-text">Threads</span>
                            <input type="number" min="1" class="form-control" id="convertThreadsInput" placeholder="Auto">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="convertDeleteOriginal" checked>
                            <label class="form-check-label" for="convertDeleteOriginal">Delete original</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="convertDryRun" checked>
                            <label class="form-check-label" for="convertDryRun">Dry run</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="convertVerbose">
                            <label class="form-check-label" for="convertVerbose">Verbose</label>
                        </div>
                        <button type="button" id="convertNszBtn" class="btn btn-warning ms-auto"
                            onClick='convertToNsz()'>Convert to NSZ</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-lg-12">
            <div class="card mb-3 h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h5 class="card-title mb-0">Task output</h5>
                        <button class="btn btn-outline-secondary btn-sm" type="button" onClick="showManageOutput([])">Clear</button>
                    </div>
                    <div class="mb-2">
                        <div class="progress" style="height: 6px;">
                            <div id="manageProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                        </div>
                        <div id="manageProgressText" class="text-muted small mt-1"></div>
                        <div id="manageCompressionText" class="text-muted small"></div>
                    </div>
                    <pre id="manageOutput" class="mb-0 flex-grow-1"
                        style="max-height: 540px; overflow: auto;"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showManageAlert(message, type = 'info') {
        const alertBox = $('#manageAlert');
        alertBox.removeClass('d-none alert-info alert-success alert-warning alert-danger');
        alertBox.addClass(`alert-${type}`);
        alertBox.text(message);
    }

    function organizeLibrary() {
        $('#organizeLibraryBtn').prop('disabled', true);
        data = {
            dry_run: $('#organizeDryRun').is(':checked'),
            verbose: $('#organizeVerbose').is(':checked')
        }
        $.ajax({
            url: "/api/manage/organize",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    showManageAlert(`Organize complete. Moved ${result['moved']} items. Skipped ${result['skipped']}.`, 'success');
                    showManageOutput(result['details']);
                } else {
                    showManageAlert(`Organize failed: ${result['errors'].join('; ')}`, 'danger');
                    showManageOutput(result['details']);
                }
            },
            complete: function () {
                $('#organizeLibraryBtn').prop('disabled', false);
            }
        });
    }

    function deleteOlderUpdates() {
        $('#deleteUpdatesBtn').prop('disabled', true);
        data = {
            dry_run: $('#deleteUpdatesDryRun').is(':checked'),
            verbose: $('#deleteUpdatesVerbose').is(':checked')
        }
        $.ajax({
            url: "/api/manage/delete-updates",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    showManageAlert(`Delete updates complete. Deleted ${result['deleted']} files. Skipped ${result['skipped']}.`, 'success');
                    showManageOutput(result['details']);
                } else {
                    showManageAlert(`Delete updates failed: ${result['errors'].join('; ')}`, 'danger');
                    showManageOutput(result['details']);
                }
            },
            complete: function () {
                $('#deleteUpdatesBtn').prop('disabled', false);
            }
        });
    }

    function convertToNsz() {
        $('#convertNszBtn').prop('disabled', true);
        data = {
            dry_run: $('#convertDryRun').is(':checked'),
            delete_original: $('#convertDeleteOriginal').is(':checked'),
            command: $('#converterCommandInput').val(),
            verbose: $('#convertVerbose').is(':checked'),
            threads: getThreadsValue()
        }
        $.ajax({
            url: "/api/manage/convert-job",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    startJobPolling(result['job_id'], 'Bulk conversion started...');
                } else {
                    showManageAlert(`Conversion failed: ${result['errors'].join('; ')}`, 'danger');
                }
            },
            complete: function () {
                $('#convertNszBtn').prop('disabled', false);
            }
        });
    }

    function loadConvertibleFiles() {
        $('#convertSingleSelect').prop('disabled', true);
        $('#convertSingleSelect').empty().append('<option value="">Loading files...</option>');
        $.getJSON("/api/manage/convertibles", function (result) {
            if (!result['success']) {
                $('#convertSingleSelect').empty().append('<option value="">Failed to load files</option>');
                return;
            }
            const files = result['files'] || [];
            if (!files.length) {
                $('#convertSingleSelect').empty().append('<option value="">No NSP/XCI files found</option>');
                return;
            }
            $('#convertSingleSelect').empty().append('<option value="">Select a file</option>');
            files.forEach(file => {
                const sizeLabel = formatFileSize(file.size || 0);
                const label = `${file.filename} (${file.extension}) - ${sizeLabel}`;
                $('#convertSingleSelect').append(`<option value="${file.id}">${label}</option>`);
            });
        }).always(function () {
            $('#convertSingleSelect').prop('disabled', false);
        });
    }

    function convertSingleFile() {
        const fileId = $('#convertSingleSelect').val();
        if (!fileId) {
            showManageAlert('Select a file to convert.', 'warning');
            return;
        }
        $('#convertSingleBtn').prop('disabled', true);
        const selectedLabel = $('#convertSingleSelect option:selected').text();
        data = {
            file_id: fileId,
            dry_run: $('#convertDryRun').is(':checked'),
            delete_original: $('#convertDeleteOriginal').is(':checked'),
            command: $('#converterCommandInput').val(),
            verbose: $('#convertVerbose').is(':checked'),
            threads: getThreadsValue()
        }
        $.ajax({
            url: "/api/manage/convert-single-job",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    startJobPolling(result['job_id'], `Single conversion started for ${selectedLabel}`);
                } else {
                    showManageAlert(`Single conversion failed: ${result['errors'].join('; ')}`, 'danger');
                }
            },
            complete: function () {
                $('#convertSingleBtn').prop('disabled', false);
            }
        });
    }

    function showManageOutput(details) {
        if (!details || !details.length) {
            $('#manageOutput').text('');
            return;
        }
        $('#manageOutput').text(details.join('\n'));
    }

    function formatFileSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex += 1;
        }
        return `${size.toFixed(size >= 10 ? 0 : 1)} ${units[unitIndex]}`;
    }

    let activeJobId = null;
    let jobPollTimer = null;
    let lastLogCount = 0;

    function getThreadsValue() {
        const val = $('#convertThreadsInput').val();
        return val ? parseInt(val, 10) : null;
    }

    function startJobPolling(jobId, startMessage) {
        activeJobId = jobId;
        lastLogCount = 0;
        showManageAlert(startMessage, 'info');
        showManageOutput([startMessage]);
        updateProgressDisplay(0, 0, 0, '');
        if (jobPollTimer) {
            clearInterval(jobPollTimer);
        }
        jobPollTimer = setInterval(fetchJobStatus, 1000);
    }

    function fetchJobStatus() {
        if (!activeJobId) {
            return;
        }
        $.getJSON(`/api/manage/convert-job/${activeJobId}`, function (result) {
            if (!result['success']) {
                showManageAlert('Failed to fetch job status.', 'danger');
                clearInterval(jobPollTimer);
                jobPollTimer = null;
                return;
            }
            const job = result['job'];
            const progress = job['progress'] || {};
            const done = progress['done'] || 0;
            const total = progress['total'] || 0;
            const percent = progress['percent'] || 0;
            const message = progress['message'] || '';
            updateProgressDisplay(done, total, percent, message);
            const logs = job['logs'] || [];
            if (logs.length > lastLogCount) {
                showManageOutput(logs);
                lastLogCount = logs.length;
            }
            if (job['status'] !== 'running') {
                clearInterval(jobPollTimer);
                jobPollTimer = null;
                if (job['status'] === 'success') {
                    showManageAlert('Conversion complete.', 'success');
                } else {
                    showManageAlert(`Conversion failed: ${job['errors'].join('; ')}`, 'danger');
                }
                loadConvertibleFiles();
            }
        });
    }

    function updateProgressDisplay(done, total, percent, message) {
        const progressPercent = total ? Math.round((done / total) * 100) : 0;
        $('#manageProgressBar').css('width', `${progressPercent}%`);
        $('#manageProgressText').text(`Progress: ${done}/${total} (${progressPercent}%)`);
        if (percent) {
            $('#manageCompressionText').text(`Compression ratio: ${percent.toFixed(1)}%`);
        } else {
            $('#manageCompressionText').text('');
        }
        if (message) {
            showManageOutput([message].concat($('#manageOutput').text().split('\n').filter(Boolean)));
        }
    }

    $(document).ready(function () {
        loadConvertibleFiles();
    });
</script>

{% endblock %}
